<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
html {
  font-family: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.markmap-dark {
  background: #27272a;
  color: white;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js"></script><script>(()=>{setTimeout(()=>{const{markmap:S,mm:Q}=window,$=new S.Toolbar;$.attach(Q);const I=$.render();I.setAttribute("style","position:absolute;bottom:20px;right:20px"),document.body.append(I)})})()</script><script>((l,U,M,R)=>{const N=l();window.mm=N.Markmap.create("svg#mindmap",(U||N.deriveOptions)(R),M),window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("markmap-dark")})(()=>window.markmap,null,{"content":"invoices-mngmt &#x2013; Backend API","children":[{"content":"Tecnolog&#xed;as","children":[{"content":"Node.js + Express","children":[],"payload":{"tag":"li","lines":"8,9"}},{"content":"TypeScript","children":[],"payload":{"tag":"li","lines":"9,10"}},{"content":"Prisma ORM + PostgreSQL","children":[],"payload":{"tag":"li","lines":"10,11"}},{"content":"JWT + Bcrypt","children":[],"payload":{"tag":"li","lines":"11,12"}},{"content":"Zod para validaciones","children":[],"payload":{"tag":"li","lines":"12,13"}},{"content":"Multer + Cloudinary para manejo de archivos","children":[],"payload":{"tag":"li","lines":"13,14"}},{"content":"Google Cloud Vision API para OCR","children":[],"payload":{"tag":"li","lines":"14,16"}}],"payload":{"tag":"h2","lines":"6,7"}},{"content":"Estructura del Proyecto","children":[{"content":"\n<p data-lines=\"20,21\">Arquitectura modular</p>","children":[],"payload":{"tag":"li","lines":"20,22"}},{"content":"\n<p data-lines=\"22,23\">src/</p>","children":[{"content":"app.ts                    # Configuraci&#xf3;n principal de Express","children":[],"payload":{"tag":"li","lines":"23,24"}},{"content":"server.ts                 # Punto de entrada del servidor","children":[],"payload":{"tag":"li","lines":"24,25"}},{"content":"config/","children":[{"content":"prisma.ts               # Cliente de Prisma","children":[],"payload":{"tag":"li","lines":"26,27"}}],"payload":{"tag":"li","lines":"25,27"}},{"content":"routes/","children":[{"content":"index.ts                # Rutas principales","children":[],"payload":{"tag":"li","lines":"28,29"}}],"payload":{"tag":"li","lines":"27,29"}},{"content":"modules/","children":[{"content":"auth/                   # M&#xf3;dulo de autenticaci&#xf3;n","children":[],"payload":{"tag":"li","lines":"30,31"}},{"content":"invoices/               # M&#xf3;dulo de facturas","children":[],"payload":{"tag":"li","lines":"31,32"}},{"content":"warranties/             # M&#xf3;dulo de garant&#xed;as","children":[],"payload":{"tag":"li","lines":"32,33"}},{"content":"imports/                # M&#xf3;dulo para importaci&#xf3;n OCR","children":[],"payload":{"tag":"li","lines":"33,34"}}],"payload":{"tag":"li","lines":"29,34"}},{"content":"shared/","children":[{"content":"middleware/","children":[{"content":"errorHandler.ts       # Middleware para manejo de errores","children":[],"payload":{"tag":"li","lines":"36,37"}},{"content":"upload.ts             # Middleware para subida de archivos","children":[],"payload":{"tag":"li","lines":"37,38"}}],"payload":{"tag":"li","lines":"35,38"}},{"content":"utils/","children":[{"content":"AppError.ts           # Clase de error personalizada","children":[],"payload":{"tag":"li","lines":"39,40"}},{"content":"extractMetadata.ts    # Utilidad para procesar texto extra&#xed;do por OCR","children":[],"payload":{"tag":"li","lines":"40,41"}},{"content":"uploadToCloudinary.ts # Utilidad para subir a cloudinary","children":[],"payload":{"tag":"li","lines":"41,43"}}],"payload":{"tag":"li","lines":"38,43"}}],"payload":{"tag":"li","lines":"34,43"}}],"payload":{"tag":"li","lines":"22,43"}},{"content":"\n<p data-lines=\"43,44\">prisma/</p>","children":[{"content":"schema.prisma             # Modelo de base de datos","children":[],"payload":{"tag":"li","lines":"44,46"}}],"payload":{"tag":"li","lines":"43,46"}}],"payload":{"tag":"h2","lines":"18,19"}},{"content":"Autenticaci&#xf3;n","children":[{"content":"<code>POST /api/auth/register</code> &#x2013; Registro de usuario","children":[],"payload":{"tag":"li","lines":"50,51"}},{"content":"<code>POST /api/auth/login</code> &#x2013; Inicio de sesi&#xf3;n","children":[],"payload":{"tag":"li","lines":"51,52"}},{"content":"<code>GET /api/auth/me</code> &#x2013; Ruta protegida para obtener datos del usuario","children":[],"payload":{"tag":"li","lines":"52,53"}},{"content":"Validaci&#xf3;n con Zod","children":[],"payload":{"tag":"li","lines":"53,54"}},{"content":"Contrase&#xf1;as encriptadas con Bcrypt","children":[],"payload":{"tag":"li","lines":"54,55"}},{"content":"Tokens JWT","children":[],"payload":{"tag":"li","lines":"55,57"}}],"payload":{"tag":"h2","lines":"48,49"}},{"content":"Facturas (<code>/api/invoices</code>)","children":[{"content":"Descarga de facturas","children":[{"content":"\n<p data-lines=\"71,72\"><code>GET /api/invoices/:id/download</code></p>","children":[{"content":"Protegido por JWT","children":[],"payload":{"tag":"li","lines":"72,73"}},{"content":"Usa <code>axios</code> para obtener el archivo desde Cloudinary","children":[],"payload":{"tag":"li","lines":"73,74"}},{"content":"Enviado al cliente como <code>stream</code>","children":[],"payload":{"tag":"li","lines":"74,76"}}],"payload":{"tag":"li","lines":"71,76"}},{"content":"\n<p data-lines=\"76,77\"><code>GET /api/invoices/:invoiceId/attachments/:attachmentId/download</code></p>","children":[{"content":"Descarga individual por ID de archivo adjunto","children":[],"payload":{"tag":"li","lines":"77,78"}},{"content":"Verifica que el archivo pertenezca a la factura y al usuario","children":[],"payload":{"tag":"li","lines":"78,79"}},{"content":"Devuelve stream seguro con headers adecuados","children":[],"payload":{"tag":"li","lines":"79,81"}}],"payload":{"tag":"li","lines":"76,81"}},{"content":"\n<p data-lines=\"81,82\">Headers:</p>","children":[{"content":"<code>Content-Disposition: attachment; filename=&quot;&lt;titulo&gt;.&lt;ext&gt;&quot;</code>","children":[],"payload":{"tag":"li","lines":"82,83"}},{"content":"<code>Content-Type</code> din&#xe1;mico","children":[],"payload":{"tag":"li","lines":"83,85"}}],"payload":{"tag":"li","lines":"81,85"}},{"content":"\n<p data-lines=\"85,86\">Beneficios:</p>","children":[{"content":"No se expone la URL de Cloudinary","children":[],"payload":{"tag":"li","lines":"86,87"}},{"content":"Forza descarga en navegador","children":[],"payload":{"tag":"li","lines":"87,88"}},{"content":"Control de acceso total","children":[],"payload":{"tag":"li","lines":"88,90"}}],"payload":{"tag":"li","lines":"85,90"}}],"payload":{"tag":"h3","lines":"69,70"}}],"payload":{"tag":"h2","lines":"59,60"}},{"content":"Importaci&#xf3;n por OCR (<code>/api/invoices/import</code>)","children":[{"content":"\n<p data-lines=\"94,95\"><code>POST /api/invoices/import</code> &#x2013; Importa factura desde URL (PDF/JPG)</p>","children":[],"payload":{"tag":"li","lines":"94,95"}},{"content":"\n<p data-lines=\"95,96\">Requiere token de autenticaci&#xf3;n</p>","children":[],"payload":{"tag":"li","lines":"95,96"}},{"content":"\n<p data-lines=\"96,97\">Procesa el archivo remoto con Google Cloud Vision API</p>","children":[],"payload":{"tag":"li","lines":"96,97"}},{"content":"\n<p data-lines=\"97,98\">Extrae texto OCR y lo interpreta para crear autom&#xe1;ticamente:</p>","children":[{"content":"La factura (<code>title</code>, <code>issueDate</code>, <code>expiration</code>, <code>provider</code>)","children":[],"payload":{"tag":"li","lines":"98,99"}},{"content":"La garant&#xed;a si se infiere duraci&#xf3;n (<code>duration</code>, <code>validUntil</code>)","children":[],"payload":{"tag":"li","lines":"99,100"}},{"content":"Un attachment con el archivo subido a Cloudinary","children":[],"payload":{"tag":"li","lines":"100,102"}}],"payload":{"tag":"li","lines":"97,102"}},{"content":"\n<p data-lines=\"102,103\">Validaci&#xf3;n extra para asegurar que la URL de attachment pertenezca a la factura (prevenci&#xf3;n de accesos inv&#xe1;lidos)</p>","children":[],"payload":{"tag":"li","lines":"102,104"}},{"content":"\n<p data-lines=\"104,105\">L&#xf3;gica encapsulada en el m&#xf3;dulo <code>imports/</code> (servicio y controlador)</p>","children":[],"payload":{"tag":"li","lines":"104,105"}},{"content":"\n<p data-lines=\"105,106\">Utiliza utilidad <code>extractMetadataFromText()</code> para analizar el contenido extra&#xed;do</p>","children":[],"payload":{"tag":"li","lines":"105,107"}}],"payload":{"tag":"h2","lines":"92,93"}},{"content":"Garant&#xed;as (<code>/api/warranties</code>)","children":[{"content":"<code>POST /</code> &#x2013; Crear garant&#xed;a asociada a factura","children":[],"payload":{"tag":"li","lines":"111,112"}},{"content":"<code>GET /:invoiceId</code> &#x2013; Obtener garant&#xed;a","children":[],"payload":{"tag":"li","lines":"112,113"}},{"content":"<code>PUT /:invoiceId</code> &#x2013; Actualizar garant&#xed;a","children":[],"payload":{"tag":"li","lines":"113,114"}},{"content":"<code>DELETE /:invoiceId</code> &#x2013; Eliminar garant&#xed;a","children":[],"payload":{"tag":"li","lines":"114,115"}},{"content":"Relaci&#xf3;n 1:1 con factura","children":[],"payload":{"tag":"li","lines":"115,116"}},{"content":"Validaci&#xf3;n con Zod","children":[],"payload":{"tag":"li","lines":"116,118"}}],"payload":{"tag":"h2","lines":"109,110"}},{"content":"Subida de Archivos","children":[{"content":"Validaci&#xf3;n de tipo MIME","children":[{"content":"Solo permite: <code>application/pdf</code>, <code>application/xml</code>, <code>text/xml</code>, <code>image/jpeg</code>, <code>image/jpg</code>, <code>image/png</code>","children":[],"payload":{"tag":"li","lines":"132,133"}},{"content":"Rechaza otros tipos con error 415","children":[],"payload":{"tag":"li","lines":"133,134"}},{"content":"Tama&#xf1;o m&#xe1;ximo: 5 MB","children":[],"payload":{"tag":"li","lines":"134,135"}},{"content":"Seguridad reforzada en la carga","children":[],"payload":{"tag":"li","lines":"135,137"}}],"payload":{"tag":"h3","lines":"130,131"}}],"payload":{"tag":"h2","lines":"120,121"}},{"content":"Consideraciones","children":[{"content":"Se mantiene <code>fileType</code> para determinar la extensi&#xf3;n esperada","children":[],"payload":{"tag":"li","lines":"141,142"}},{"content":"El nombre del archivo se genera desde <code>title</code> de la factura","children":[],"payload":{"tag":"li","lines":"142,143"}},{"content":"Descarga ahora permite seleccionar un archivo espec&#xed;fico por ID","children":[],"payload":{"tag":"li","lines":"143,144"}},{"content":"Posibilidad futura: descargar todos como archivo ZIP","children":[],"payload":{"tag":"li","lines":"144,145"}},{"content":"OCR habilitado para automatizar ingreso de facturas desde imagen o PDF","children":[],"payload":{"tag":"li","lines":"145,147"}}],"payload":{"tag":"h2","lines":"139,140"}},{"content":"Scripts","children":[{"content":"<pre data-lines=\"151,158\"><code class=\"language-bash\">npm run dev       <span class=\"hljs-comment\"># Desarrollo con recarga</span>\nnpm run build     <span class=\"hljs-comment\"># Compilaci&#xf3;n TypeScript</span>\nnpm run start     <span class=\"hljs-comment\"># Producci&#xf3;n</span>\nnpx prisma ...    <span class=\"hljs-comment\"># Comandos Prisma</span>\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"151,158"}}],"payload":{"tag":"h2","lines":"149,150"}},{"content":"&#x1f4bb; Instalaci&#xf3;n y uso local","children":[{"content":"Clona el repositorio","children":[{"content":"<pre data-lines=\"165,169\"><code class=\"language-bash\">git <span class=\"hljs-built_in\">clone</span> https://github.com/tu-usuario/invoices_mngmt.git\n<span class=\"hljs-built_in\">cd</span> invoices_mngmt/backend\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"165,169"}}],"payload":{"tag":"h3","lines":"163,164"}},{"content":"Instala dependencias","children":[{"content":"<pre data-lines=\"172,175\"><code class=\"language-bash\">npm install\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"172,175"}}],"payload":{"tag":"h3","lines":"170,171"}},{"content":"Configura variables de entorno","children":[{"content":"<pre data-lines=\"178,187\"><code class=\"language-env\">DATABASE_URL=postgresql://usuario:password@localhost:5432/facturas_db\nJWT_SECRET=tu_clave_secreta\nSALT_ROUNDS=10\nCLOUDINARY_CLOUD_NAME=xxx\nCLOUDINARY_API_KEY=xxx\nCLOUDINARY_API_SECRET=xxx\nGOOGLE_APPLICATION_CREDENTIALS=./ruta/clave-ocr.json\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"178,187"}}],"payload":{"tag":"h3","lines":"176,177"}},{"content":"Ejecuta migraciones","children":[{"content":"<pre data-lines=\"190,193\"><code class=\"language-bash\">npx prisma migrate dev --name init\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"190,193"}}],"payload":{"tag":"h3","lines":"188,189"}},{"content":"Inicia el servidor","children":[{"content":"<pre data-lines=\"196,199\"><code class=\"language-bash\">npm run dev\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"196,199"}}],"payload":{"tag":"h3","lines":"194,195"}}],"payload":{"tag":"h2","lines":"161,162"}},{"content":"&#x1f4d6; Documentaci&#xf3;n de la API","children":[{"content":"Pronto estar&#xe1; disponible una colecci&#xf3;n de Postman o documentaci&#xf3;n Swagger con todos los endpoints.","children":[],"payload":{"tag":"li","lines":"204,206"}}],"payload":{"tag":"h2","lines":"202,203"}},{"content":"&#x1f4dd; Licencia","children":[{"content":"Este proyecto est&#xe1; bajo la licencia MIT. Libre para uso, modificaci&#xf3;n y distribuci&#xf3;n con atribuci&#xf3;n.","children":[],"payload":{"tag":"li","lines":"210,212"}}],"payload":{"tag":"h2","lines":"208,209"}},{"content":"&#x1f64b;&#x200d;&#x2642;&#xfe0f; Autor","children":[{"content":"Desarrollado por Mario Quir&#xf3;s","children":[{"content":"<pre data-lines=\"218,221\"><code class=\"language-bash\">&lt;https://github.com/MQuirosP&gt;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"218,221"}}],"payload":{"tag":"h3","lines":"216,217"}}],"payload":{"tag":"h2","lines":"214,215"}}],"payload":{"tag":"h1","lines":"0,1"}},null)</script>
</body>
</html>
